<html>
<head>
<meta name=vsisbn content="067231486x">
<meta name=vstitle content="Programming Microsoft Windows 2000 Unleashed">
<meta name=vsauthor content="MICKEY WILLIAMS">
<meta name=vsimprint content="Sams">
<meta name=vspublisher content="Macmillan Computer Publishing">
<meta name=vspubdate content="06/21/99">
<meta name=vscategory content="Operations Systems: Windows 2000">



<title>Programming Microsoft Windows 2000 Unleashed:Developing ActiveX Controls</TITLE>
<!-- BEGIN HEADER -->
<meta name="ROBOTS" content="NOINDEX, NOFOLLOW">
<script>
<!--
function displayWindow(url, width, height) {
        var Win = window.open(url,"displayWindow",'width=' + width +
',height=' + height + ',resizable=1,scrollbars=yes');
}
//--></SCRIPT>

<!-- HEADER -->
<style type="text/css">
<!--
A:hover { color:red }
-->
</STYLE>

<!-- HEADER -->
<style type="text/css"> 
 <!--
 A:hover  {
 	color : Red;
 }
 -->
 </STYLE>

</HEAD>
<BODY bgcolor=#FFFFFF><FONT size=2 face="Arial, verdana, helvetica"><table width=100% border=0 cellspacing=0 cellpadding=2><tr bgcolor=#000000><td width=100% align=right><b><font color=#FFFFFF>Gotcha</font></b></td></tr></table><br><!--Begin Content Column -->

<table border=0 cellspacing=0 cellpadding=0>
<tr>
<td width=75 valign=top>
<img webstripperattrwas="src" webstripperlinkwas="http://corpitk.earthweb.com/images/sm_covers/067231486x.gif" width=60 height=73 alt="Programming Microsoft Windows 2000 Unleashed" border="1">
</td>
<td align="left">
    <font face="arial, helvetica" size="-1" color="#336633"><b>Programming Microsoft Windows 2000 Unleashed</b></font>
    <br>
    <font face="arial, helvetica" size="-1"><i>by MICKEY WILLIAMS</i>
    <br>
    Sams,&nbsp;Macmillan Computer Publishing
    <br>
    <b>ISBN:</b>&nbsp;067231486x<b>&nbsp;&nbsp;&nbsp;Pub Date:</b>&nbsp;06/21/99</font>
</td>
</tr>
</table>
<p>
<!-- Empty Reference Subhead-->

<!--ISBN=067231486x//-->
<!--TITLE=Programming Microsoft Windows 2000 Unleashed//-->
<!--AUTHOR=Mickey Williams//-->
<!--PUBLISHER=Macmillan Computer Publishing//-->
<!--IMPRINT=sams//-->
<!--CHAPTER=18//-->
<!--PAGES=604-608//-->
<!--UNASSIGNED1//-->
<!--UNASSIGNED2//-->

<center>
<table border>
<tr>
<td><a href="18-09.html">Previous</A></TD>
<td><a href="../ewtoc.html">Table of Contents</A></TD>
<td><a href="18-11.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>
<p><br></P>
<p>Open the <small>PopBtn.IDL</SMALL> file and add the two lines shown in bold in Listing 18.11 to the <small>_IPopButtonEvents</SMALL> interface. Alternatively, you could also add the events by right-clicking the <small>_IPopButtonEvents</SMALL> icon in ClassView and selecting Add Method from the pop-up menu.</P>
<p><b>Listing 18.11</B> Changes to the <small>PopButton.IDL</SMALL> File to Add Outgoing Events (in Bold)<hr></P>
<!-- CODE //-->
<pre>
library POPBTNLib
{
    importlib(&#147;stdole32.tlb&#148;);
    importlib(&#147;stdole2.tlb&#148;);
    [
        uuid(220DB0C9-89BD-11D2-B877-00104B36573E),
        helpstring(&#147;_IPopButtonEvents Interface&#148;)
    ]
    dispinterface _IPopButtonEvents
    {
        properties:
        methods:
        <b>[id(1), helpstring(&#147;OnClick event&#148;)] HRESULT OnClick();
       [id(2), helpstring(&#147;OnHover event&#148;)] HRESULT OnHover();</B>
    };
    [
        uuid(220DB0C8-89BD-11D2-B877-00104B36573E),
        helpstring(&#147;PopButton Class&#148;)
    ]
    coclass PopButton
    {
        [default] interface IPopButton;
        [default, source] dispinterface _IPopButtonEvents;
    };
};
</PRE>
<!-- END CODE //-->
<p><hr></P>
<p>Before proceeding, compile the skeleton project. This will compile the type library and make it possible to add the event connection points for the control.</P>
<p>After the project has been compiled, add the connection points to the PopButton project by right-clicking the <small>CPopButton</SMALL> icon and selecting Implement Connection Point from the pop-up menu. Select the checkbox next to <small>_IPopButtonEvents</SMALL> and click the OK button. The <small>CProxy_IPopButtonEvents</SMALL> class will be automatically generated and added to the project.</P>
<p><font size="+1"><b>Modifications to the Message Map</B></FONT></P>
<p>Seven messages must be added to the <small>CPopButton</SMALL> message map. Six of the messages are generated by the operating system, and one message, <small>BN_CLICKED</SMALL>, is generated by the superclassed pushbutton control.</P>
<p>As discussed earlier, you can open the dialog box that adds message-handling functions by right-clicking the <small>CPopButton</SMALL> icon in ClassView and selecting Add Windows Message Handler from the pop-up menu. Add handlers for these six messages:</P>
<dl>
<dd><b>&#149;</B>&nbsp;&nbsp;<small>WM_ERASEBKGND</SMALL>
<dd><b>&#149;</B>&nbsp;&nbsp;<small>WM_KILLFOCUS</SMALL>
<dd><b>&#149;</B>&nbsp;&nbsp;<small>WM_LBUTTONDOWN</SMALL>
<dd><b>&#149;</B>&nbsp;&nbsp;<small>WM_LBUTTONUP</SMALL>
<dd><b>&#149;</B>&nbsp;&nbsp;<small>WM_MOUSEMOVE</SMALL>
</DL>
<p>You must also manually add <small>COMMAND_CODE_HANDLER</SMALL> macros for the <small>BN_CLICKED</SMALL> and <small>WM_MOUSELEAVE</SMALL> messages to the message map. The finished message map is shown in Listing 18.12, with the manually added macros shown in bold. Note that all the message handlers are in the main part of the message map. Make sure your message map doesn&#146;t have any message-handling macros in the alternate message map.</P>
<p><b>Listing 18.12</B> The Message Map for the PopButton Project<hr></P>
<!-- CODE //-->
<pre>
BEGIN_MSG_MAP(CPopButton)
    MESSAGE_HANDLER(WM_CREATE, OnCreate)
    MESSAGE_HANDLER(WM_SETFOCUS, OnSetFocus)
    MESSAGE_HANDLER(WM_ERASEBKGND, OnEraseBkgnd)
    MESSAGE_HANDLER(WM_KILLFOCUS, OnKillFocus)
    MESSAGE_HANDLER(WM_LBUTTONDOWN, OnLButtonDown)
    MESSAGE_HANDLER(WM_LBUTTONUP, OnLButtonUP)
    MESSAGE_HANDLER(WM_MOUSEMOVE, OnMouseMove)
    MESSAGE_HANDLER(WM_MOUSELEAVE, OnMouseLeave)
    <b>COMMAND_CODE_HANDLER(BN_CLICKED, OnClicked)</B>
    CHAIN_MSG_MAP(CComControl&ltCPopButton&gt)
ALT_MSG_MAP(1)
    // Replace this with message map entries for superclassed Button
END_MSG_MAP()
</PRE>
<!-- END CODE //-->
<p><hr></P>
<p><font size="+1"><b>Initializing the CPopButton Object</B></FONT></P>
<p>Before adding the code needed to initialize the <small>CPopButton</SMALL> class, add an enumeration used to track button states to the <small>PopButton.cpp</SMALL> source file. Insert the contents of Listing 18.13 just above the declaration of the <small>CPopButton</SMALL> class.</P>
<p><b>Listing 18.13</B> The <small>BtnState</SMALL> Enumeration<hr></P>
<!-- CODE SNIP //-->
<pre>
enum BtnState { bsFlat, bsDown, bsHover };
</PRE>
<!-- END CODE SNIP //-->
<hr>
<p>Earlier in this chapter, when the stock properties were added to the PopButton ATL object, the ATL Object Wizard inserted member variables to hold these stock values into the <small>CPopButton</SMALL> class. Those values are shown in Listing 18.14. Add the member variables shown in bold to the class declaration.</P>
<p><b>Listing 18.14</B> Additional Member Variables Used by <small>CPopButton</SMALL> (in Bold)<hr></P>
<!-- CODE SNIP //-->
<pre>
OLE_COLOR          m_clrBackColor;
CComBSTR           m_bstrCaption;
OLE_COLOR          m_clrForeColor;
BOOL               m_bTabStop;
<b>CComPtr&ltIFontDisp&gt m_pFont;    // Contains ambient font
BtnState         m_btnState;   // Tracks button state
bool             m_fHasFocus;  // TRUE is button has focus
short            m_cBevelSize; // Stores size of beveled edge</B>
</PRE>
<!-- END CODE SNIP //-->
<p><hr></P>
<p>The <small>m_cBevelSize</SMALL> member variable is used to store the <small>BevelSize</SMALL> property. As noted in the comments, the other variables track the current button, the input focus state for the control, and the ambient font.</P>
<p>Add the lines shown in bold in Listing 18.15 to the <small>CPopButton</SMALL> constructor.</P>
<p><b>Listing 18.15</B> The Constructor for the <small>CPopButton</SMALL> Class, with Changes in Bold<hr></P>
<!-- CODE SNIP //-->
<pre>
CPopButton() :
    m_ctlButton(_T(&#147;Button&#148;), this, 1),
     <b>m_btnState(bsFlat),
    m_fHasFocus(false),
    m_cBevelSize(2)</B>
{
    m_bWindowOnly = TRUE;
}
</PRE>
<!-- END CODE SNIP //-->
<p><hr></P>
<p>The default handler for <small>OnCreate</SMALL> will superclass a default instance of the Windows <small>BUTTON</SMALL> class. The PopButton control must superclass a <small>BUTTON</SMALL> with pushbutton attributes, so modify the <small>OnCreate</SMALL> member function as shown in Listing 18.16 by changing the lines in bold.</P>
<p><b>Listing 18.16</B> Changes Made to the <small>OnCreate</SMALL> Member Function (in Bold)<hr></P>
<!-- CODE //-->
<pre>
LRESULT OnCreate(UINT , WPARAM , LPARAM , BOOL&amp )
{
    RECT rc;
    GetWindowRect(&amprc);
    rc.right -= rc.left;
    rc.bottom -= rc.top;
    rc.top = rc.left = 0;
    <b>m_ctlButton.Create(m_hWnd,
                       rc,
                       _T(&#147;BUTTON&#148;),
                       WS_CHILD|BS_PUSHBUTTON);</B>
return 0;
}
</PRE>
<!-- END CODE //-->
<hr>
<p><font size="+1"><b>Retrieving Ambient Properties</B></FONT></P>
<p>When the control is initially loaded, it will collect the current foreground color, background color, and font from its container. A good time to collect ambient properties is when the control and its container negotiate the client site. Add the source code in Listing 18.17 to the <small>PopButton.cpp</SMALL> source file. This function will override the base class implementation of <small>SetClientSite</SMALL> and will store the ambient values of these three properties.</P>
<p><b>Listing 18.17</B> A New Version of <small>SetClientSite</SMALL> That Collects Ambient Properties from the Container<hr></P>
<!-- CODE //-->
<pre>
STDMETHODIMP CPopButton::SetClientSite(LPOLECLIENTSITE pSite)
{
    HRESULT hr = CComControlBase::IOleObject_SetClientSite(pSite);
    if(!m_pFont &amp&amp pSite)
    {
        hr = GetAmbientFontDisp(&ampm_pFont);
    }
    GetAmbientBackColor(m_clrBackColor);
    GetAmbientForeColor(m_clrForeColor);
    return hr;
}
</PRE>
<!-- END CODE //-->
<p><hr></P>
<p>Add the following member function declaration to the <small>CPopButton</SMALL> class. A good place to locate it is just after all the member variables used to track properties:</P>
<!-- CODE SNIP //-->
<pre>
STDMETHOD(SetClientSite)(LPOLECLIENTSITE pSite);
</PRE>
<!-- END CODE SNIP //-->
<p><br></P>
<center>
<table border>
<tr>
<td><a href="18-09.html">Previous</A></TD>
<td><a href="../ewtoc.html">Table of Contents</A></TD>
<td><a href="18-11.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>


</font></BODY></HTML>