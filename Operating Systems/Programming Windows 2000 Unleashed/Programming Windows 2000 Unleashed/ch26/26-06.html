<html>
<head>
<meta name=vsisbn content="067231486x">
<meta name=vstitle content="Programming Microsoft Windows 2000 Unleashed">
<meta name=vsauthor content="MICKEY WILLIAMS">
<meta name=vsimprint content="Sams">
<meta name=vspublisher content="Macmillan Computer Publishing">
<meta name=vspubdate content="06/21/99">
<meta name=vscategory content="Operations Systems: Windows 2000">



<title>Programming Microsoft Windows 2000 Unleashed:Pipes</TITLE>
<!-- BEGIN HEADER -->
<meta name="ROBOTS" content="NOINDEX, NOFOLLOW">
<script>
<!--
function displayWindow(url, width, height) {
        var Win = window.open(url,"displayWindow",'width=' + width +
',height=' + height + ',resizable=1,scrollbars=yes');
}
//--></SCRIPT>

<!-- HEADER -->
<style type="text/css">
<!--
A:hover { color:red }
-->
</STYLE>

<!-- HEADER -->
<style type="text/css"> 
 <!--
 A:hover  {
 	color : Red;
 }
 -->
 </STYLE>

</HEAD>
<BODY bgcolor=#FFFFFF><FONT size=2 face="Arial, verdana, helvetica"><table width=100% border=0 cellspacing=0 cellpadding=2><tr bgcolor=#000000><td width=100% align=right><b><font color=#FFFFFF>Gotcha</font></b></td></tr></table><br><!--Begin Content Column -->

<table border=0 cellspacing=0 cellpadding=0>
<tr>
<td width=75 valign=top>
<img webstripperattrwas="src" webstripperlinkwas="http://corpitk.earthweb.com/images/sm_covers/067231486x.gif" width=60 height=73 alt="Programming Microsoft Windows 2000 Unleashed" border="1">
</td>
<td align="left">
    <font face="arial, helvetica" size="-1" color="#336633"><b>Programming Microsoft Windows 2000 Unleashed</b></font>
    <br>
    <font face="arial, helvetica" size="-1"><i>by MICKEY WILLIAMS</i>
    <br>
    Sams,&nbsp;Macmillan Computer Publishing
    <br>
    <b>ISBN:</b>&nbsp;067231486x<b>&nbsp;&nbsp;&nbsp;Pub Date:</b>&nbsp;06/21/99</font>
</td>
</tr>
</table>
<p>
<!-- Empty Reference Subhead-->

<!--ISBN=067231486x//-->
<!--TITLE=Programming Microsoft Windows 2000 Unleashed//-->
<!--AUTHOR=Mickey Williams//-->
<!--PUBLISHER=Macmillan Computer Publishing//-->
<!--IMPRINT=sams//-->
<!--CHAPTER=26//-->
<!--PAGES=899-903//-->
<!--UNASSIGNED1//-->
<!--UNASSIGNED2//-->

<center>
<table border>
<tr>
<td><a href="26-05.html">Previous</A></TD>
<td><a href="../ewtoc.html">Table of Contents</A></TD>
<td><a href="../ch27/27-01.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>
<p><br></P>
<h4 align="LEFT"><a name="Heading14"></A><font color="#000077">A Named Pipe Client Application</FONT></H4>
<p>The NPClient project is an example of a dialog-based MFC application that uses named pipes to exchange information with another process. In this case, NPClient connects to BardServ via a named pipe and displays a quotation from Shakespeare in its main dialog box.
</P>
<p>The main dialog box for NPClient is shown in Figure 26.3. Note that a new static text control is included that covers most of the dialog box area; a new pushbutton control is also included.</P>
<p><a name="Fig3"></A><a href="javascript:displayWindow('../WebStripper/protected.html#link=http://corpitk.earthweb.com/reference/pro/067231486x/ch26/images/26-03.jpg',800,600 )"><img webstripperattrwas="src" webstripperlinkwas="http://corpitk.earthweb.com/reference/pro/067231486x/ch26/images/26-03t.jpg"></A>
<br><a href="javascript:displayWindow('../WebStripper/protected.html#link=http://corpitk.earthweb.com/reference/pro/067231486x/ch26/images/26-03.jpg',800,600)"><font color="#000077"><b>Figure 26.3</B></FONT></A>&nbsp;&nbsp;The main dialog box for NPClient.</P>
<p>Table 26.3 contains the resource IDs for new controls added to the main dialog box.
</P>
<caption align="LEFT" valign="TOP" colspan="3"><b>Table 26.3</B> Resource and Control Information for the Main Dialog Box
<table width="100%">
<tr>
<td colspan="3"><hr>
<tr>
<th valign="TOP" align="LEFT" width="30%"><i>Control</I>
<th valign="TOP" align="LEFT" width="30%"><i>Resource ID</I>
<th valign="TOP" align="LEFT" width="40%"><i>Caption</I>
<tr>
<td colspan="3"><hr>
<tr>
<td valign="TOP" align="LEFT">Static text control
<td valign="TOP" align="LEFT"><small>IDC_MSG</SMALL>
<td valign="TOP" align="LEFT"><small>Click the Quote button</SMALL>
<tr>
<td valign="TOP" align="LEFT">Quote button
<td valign="TOP" align="LEFT"><small>IDC_QUOTE</SMALL>
<td valign="TOP" align="LEFT"><small>&ampQuote</SMALL>
<tr>
<td colspan="3"><hr>
<tr>
</TABLE>
<p>ClassWizard was used to add a message-handling function to the <small>CNPClientDlg</SMALL> class. This function handles <small>BN_CLICKED</SMALL> messages from the Quote button, as shown in Table 26.4.</P>
<caption align="LEFT" valign="TOP" colspan="4"><b>Table 26.4</B> Message-handling Information for <small>CNPClientDlg</SMALL>
<table width="100%">
<tr>
<td colspan="4"><hr>
<tr>
<th valign="TOP" align="LEFT" width="25%"><i>Class Name Function</I>
<th valign="TOP" align="LEFT" width="25%"><i>Object ID</I>
<th valign="TOP" align="LEFT" width="25%"><i>Message</I>
<th valign="TOP" align="LEFT" width="25%"><i>Member</I>
<tr>
<td colspan="4"><hr>
<tr>
<td valign="TOP" align="LEFT"><small>CNPClientDlg</SMALL>
<td valign="TOP" align="LEFT"><small>IDC_QUOTE</SMALL>
<td valign="TOP" align="LEFT"><small>BN_CLICKED</SMALL>
<td valign="TOP" align="LEFT"><small>OnQuote</SMALL>
<tr>
<td colspan="4"><hr>
<tr>
</TABLE>
<p>The <small>CNPClientDlg</SMALL> class is modified by adding a named pipe handle and extra member functions to take care of the communications through the named pipe. The changes shown in bold in Listing 26.6 have been made to the <small>CNPClientDlg</SMALL> class declaration.</P>
<p><b>Listing 26.6</B> Changes (in Bold) to the <small>CNPClientDlg</SMALL> Class Declaration<hr></P>
<!-- CODE //-->
<pre>
class CNPClientDlg : public CDialog
{
.
.
.
// Implementation
protected:
    HICON  m_hIcon;
    <b>HANDLE m_hPipe;

    void SendQuitMsg();
    int  ErrorHandling(LPCTSTR lpszTitle);
    void GetQuote();</B>
.
.
.
};
</PRE>
<!-- END CODE //-->
<hr>
<p>Listing 26.7 contains the source code for the <small>CNPClientDlg::OnQuote</SMALL> member function, which is called when the user clicks the Quote button. The <small>OnQuote</SMALL> function attempts to open the client side of the named pipe, fetches a quotation, and then releases the named pipe.</P>
<p><b>Listing 26.7</B> The <small>CNPClientDlg::OnQuote</SMALL> Member Function<hr></P>
<!-- CODE //-->
<pre>
void CNPClientDlg::OnQuote()
{
    m_hPipe = CreateFile(_T(&#147;\\\\.\\pipe\\Quote&#148;),
                         GENERIC_READ | GENERIC_WRITE,
                         0,
                         NULL,
                         OPEN_EXISTING,
                         0,
                         NULL);
    if(m_hPipe == INVALID_HANDLE_VALUE)
    {
        ErrorHandling(_T(&#147;CreateFile Failed&#148;));
        return;
    }
    DWORD dwPipeState = PIPE_READMODE_MESSAGE;
    BOOL fChangedState = SetNamedPipeHandleState(m_hPipe,
                                                 &ampdwPipeState,
                                                 NULL,
                                                 NULL);
    if(fChangedState == FALSE)
    {
        ErrorHandling(_T(&#147;SetNamedPipeHandleState Failed&#148;));
        return;
    }
    //Get a quotation from the BardServ, and quit the connection
    GetQuote();
    SendQuitMsg();
    CloseHandle(m_hPipe);
}
</PRE>
<!-- END CODE //-->
<hr>
<p>Three additional functions exist for <small>CNPClientDlg</SMALL>:</P>
<dl>
<dd><b>&#149;</B>&nbsp;&nbsp;<small>ErrorHandling</SMALL>. Handles system error messages, same as in BardServ.
<dd><b>&#149;</B>&nbsp;&nbsp;<small>GetQuote</SMALL>. Sends the string &#147;Quote&#148; to BardServ and waits for the quotation to be returned. After reading the quotation from the pipe, <small>GetQuote</SMALL> displays the message in the dialog box.
<dd><b>&#149;</B>&nbsp;&nbsp;<small>SendQuitMessage</SMALL>. Sends the string &#147;Quit&#148; to BardServ in order to shut down the pipe.
</DL>
<p>Listing 26.8 shows the source code for the remaining <small>CNPClientDlg</SMALL> member functions.</P>
<p><b>Listing 26.8</B> Additional Member Functions for <small>CNPClientDlg</SMALL><hr></P>
<!-- CODE //-->
<pre>
void CNPClientDlg::GetQuote()
{
    const int cBuffer = 1024;
    TCHAR szBuffer[cBuffer];
    ASSERT(m_hPipe != INVALID_HANDLE_VALUE);

    TCHAR szMsg[] = _T(&#147;Quote&#148;);
    DWORD dwWritten, dwRead;

    BOOL fWritten = WriteFile(m_hPipe,
                              szMsg,
                              sizeof(szMsg),
                              &ampdwWritten,
                              NULL);
    if(fWritten == FALSE || dwWritten == 0)
    {
        ErrorHandling(_T(&#147;WriteFile failed&#148;));
        return;
    }
    BOOL fRead = ReadFile(m_hPipe,
                          szBuffer,
                          cBuffer,
                          &ampdwRead,
                          NULL);
    if(fRead == FALSE || dwRead == 0)
    {
        ErrorHandling(_T(&#147;ReadFile failed&#148;));
        return;
    }
    szBuffer[dwRead] = &#145;\0&#146;;
    SetDlgItemText(IDC_MSG, szBuffer);
}

void CNPClientDlg::SendQuitMsg()
{
    ASSERT(m_hPipe != INVALID_HANDLE_VALUE);
    DWORD dwWritten;
    TCHAR szQuit[] = _T(&#147;Quit&#148;);
    BOOL fWritten = WriteFile(m_hPipe,
                              szQuit,
                              sizeof(szQuit),
                              &ampdwWritten,
                              NULL );
}

int CNPClientDlg::ErrorHandling(LPCTSTR lpszTitle)
{
    TCHAR szBuffer[256];
    FormatMessage(FORMAT_MESSAGE_FROM_SYSTEM,
                  NULL,
                  GetLastError(),
                  MAKELANGID(LANG_ENGLISH, SUBLANG_ENGLISH_US),
                  szBuffer,
                  256,
                  NULL);
    MessageBox(szBuffer, lpszTitle, MB_ICONSTOP);
    return 1;
}
</PRE>
<!-- END CODE //-->
<hr>
<p>Compile and run the BardServ and NPClient projects. While debugging or testing named pipes, I find it helpful to run two instances of the Visual C<small>&#43;&#43;</SMALL> Developer Studio at the same time&#151;one for each end of the pipe.</P>
<p>Figure 26.4 shows three copies of NPClient running with one copy of BardServ. Note the status messages displayed in the BardServ console window.</P>
<p><a name="Fig4"></A><a href="javascript:displayWindow('../WebStripper/protected.html#link=http://corpitk.earthweb.com/reference/pro/067231486x/ch26/images/26-04.jpg',701,527 )"><img webstripperattrwas="src" webstripperlinkwas="http://corpitk.earthweb.com/reference/pro/067231486x/ch26/images/26-04t.jpg"></A>
<br><a href="javascript:displayWindow('../WebStripper/protected.html#link=http://corpitk.earthweb.com/reference/pro/067231486x/ch26/images/26-04.jpg',701,527)"><font color="#000077"><b>Figure 26.4</B></FONT></A>&nbsp;&nbsp;Three instances of NPClient running with BardServ.</P>
<h3><a name="Heading15"></A><font color="#000077">Summary</FONT></H3>
<p>This chapter explained how you can use pipes for interprocess communications in Windows 2000 applications. You learned about using named and anonymous pipes. You also created two sets of sample applications&#151;two programs that demonstrate how anonymous pipes are used, and two programs that demonstrate named pipes.
</P><p><br></P>
<center>
<table border>
<tr>
<td><a href="26-05.html">Previous</A></TD>
<td><a href="../ewtoc.html">Table of Contents</A></TD>
<td><a href="../ch27/27-01.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>


</font></BODY></HTML>