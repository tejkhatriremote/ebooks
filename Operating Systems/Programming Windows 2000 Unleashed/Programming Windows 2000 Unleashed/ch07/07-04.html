<html>
<head>
<meta name=vsisbn content="067231486x">
<meta name=vstitle content="Programming Microsoft Windows 2000 Unleashed">
<meta name=vsauthor content="MICKEY WILLIAMS">
<meta name=vsimprint content="Sams">
<meta name=vspublisher content="Macmillan Computer Publishing">
<meta name=vspubdate content="06/21/99">
<meta name=vscategory content="Operations Systems: Windows 2000">



<title>Programming Microsoft Windows 2000 Unleashed:Distributed Security</TITLE>
<!-- BEGIN HEADER -->
<meta name="ROBOTS" content="NOINDEX, NOFOLLOW">
<script>
<!--
function displayWindow(url, width, height) {
        var Win = window.open(url,"displayWindow",'width=' + width +
',height=' + height + ',resizable=1,scrollbars=yes');
}
//--></SCRIPT>

<!-- HEADER -->
<style type="text/css">
<!--
A:hover { color:red }
-->
</STYLE>

<!-- HEADER -->
<style type="text/css"> 
 <!--
 A:hover  {
 	color : Red;
 }
 -->
 </STYLE>

</HEAD>
<BODY bgcolor=#FFFFFF><FONT size=2 face="Arial, verdana, helvetica"><table width=100% border=0 cellspacing=0 cellpadding=2><tr bgcolor=#000000><td width=100% align=right><b><font color=#FFFFFF>Gotcha</font></b></td></tr></table><br><!--Begin Content Column -->

<table border=0 cellspacing=0 cellpadding=0>
<tr>
<td width=75 valign=top>
<img webstripperattrwas="src" webstripperlinkwas="http://corpitk.earthweb.com/images/sm_covers/067231486x.gif" width=60 height=73 alt="Programming Microsoft Windows 2000 Unleashed" border="1">
</td>
<td align="left">
    <font face="arial, helvetica" size="-1" color="#336633"><b>Programming Microsoft Windows 2000 Unleashed</b></font>
    <br>
    <font face="arial, helvetica" size="-1"><i>by MICKEY WILLIAMS</i>
    <br>
    Sams,&nbsp;Macmillan Computer Publishing
    <br>
    <b>ISBN:</b>&nbsp;067231486x<b>&nbsp;&nbsp;&nbsp;Pub Date:</b>&nbsp;06/21/99</font>
</td>
</tr>
</table>
<p>
<!-- Empty Reference Subhead-->

<!--ISBN=067231486x//-->
<!--TITLE=Programming Microsoft Windows 2000 Unleashed//-->
<!--AUTHOR=Mickey Williams//-->
<!--PUBLISHER=Macmillan Computer Publishing//-->
<!--IMPRINT=sams//-->
<!--CHAPTER=07//-->
<!--PAGES=240-242//-->
<!--UNASSIGNED1//-->
<!--UNASSIGNED2//-->

<center>
<table border>
<tr>
<td><a href="07-03.html">Previous</A></TD>
<td><a href="../ewtoc.html">Table of Contents</A></TD>
<td><a href="07-05.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>
<p><br></P>
<p><font size="+1"><b>The ACE Structure</B></FONT></P>
<p>An <small>ACE</SMALL>, or <i>access control entry</I> structure, is used to specify a type of action to be taken for a particular user or group with respect to security. Each <small>ACE</SMALL> contains a <small>SID</SMALL> that identifies a security trustee and a set of masks that contain the rights for the trustee.</P>
<p>Here are the six different types of <small>ACE</SMALL> structures:</P>
<dl>
<dd><b>&#149;</B>&nbsp;&nbsp;<small>ACCESS_ALLOWED_ACE</SMALL>. An <small>ACE</SMALL> that specifies a user or group that&#146;s allowed access to a securable object.
<dd><b>&#149;</B>&nbsp;&nbsp;<small>ACCESS_DENIED_ACE</SMALL>. An <small>ACE</SMALL> that specifies a user or group that&#146;s denied access to a securable object.
<dd><b>&#149;</B>&nbsp;&nbsp;<small>SYSTEM_AUDIT_ACE</SMALL>. An <small>ACE</SMALL> that specifies a user or group that causes a security audit event to be generated.
<dd><b>&#149;</B>&nbsp;&nbsp;<small>ACCESS_ALLOWED_OBJECT_ACE</SMALL>. An <small>ACE</SMALL> used in Active Directory that&#146;s similar to the <small>ACCESS_ALLOWED_ACE</SMALL> structure. It adds information that controls the inheritance of the <small>ACE</SMALL> by child objects.
<dd><b>&#149;</B>&nbsp;&nbsp;<small>ACCESS_DENIED_OBJECT_ACE</SMALL>. An <small>ACE</SMALL> used in Active Directory that&#146;s similar to the <small>ACCESS_DENIED_ACE</SMALL> structure. It adds information that controls inheritance of the <small>ACE</SMALL> by child objects.
<dd><b>&#149;</B>&nbsp;&nbsp;<small>SYSTEM_AUDIT_OBJECT_ACE</SMALL>. An <small>ACE</SMALL> used in Active Directory that&#146;s similar to the <small>ACCESS_ALLOWED_ACE</SMALL> structure. It adds information that controls inheritance of the <small>ACE</SMALL> by child objects.
</DL>
<p>All <small>ACE</SMALL> structures have a similar format. Figure 7.2 shows the memory layout for an <small>ACCESS_ALLOWED_ACE</SMALL> structure.</P>
<p><font size="+1"><b>The DACL and SACL Structures</B></FONT></P>
<p>Every securable object may have two <small>ACL</SMALL>s, or <i>access control lists</I>, associated with it:</P>
<dl>
<dd><b>&#149;</B>&nbsp;&nbsp;A <small>DACL</SMALL>, or <i>discretionary access list</I>, which specifies the users and groups permitted access to the object
<dd><b>&#149;</B>&nbsp;&nbsp;A <small>SACL</SMALL>, or <i>system access control list</I>, which specifies the conditions that cause a security audit event to be generated for the object
</DL>
<p><a name="Fig2"></A><a href="javascript:displayWindow('../WebStripper/protected.html#link=http://corpitk.earthweb.com/reference/pro/067231486x/ch07/images/07-02.jpg',151,420 )"><img webstripperattrwas="src" webstripperlinkwas="http://corpitk.earthweb.com/reference/pro/067231486x/ch07/images/07-02t.jpg"></A>
<br><a href="javascript:displayWindow('../WebStripper/protected.html#link=http://corpitk.earthweb.com/reference/pro/067231486x/ch07/images/07-02.jpg',151,420)"><font color="#000077"><b>Figure 7.2</B></FONT></A>&nbsp;&nbsp;The layout of an <small>ACCESS_ALLOWED_ACE</SMALL>.
</P>
<p>Both <small>DACL</SMALL>s and <small>SACL</SMALL>s are arrays of <small>ACE</SMALL> structures, beginning with an <small>ACL</SMALL> structure used as a header for the list. A <small>SACL</SMALL> contains only system audit <small>ACE</SMALL> structures, and a <small>DACL</SMALL> contains only access-allowed or access-denied <small>ACE</SMALL> structures. <small>ACE</SMALL>s in a <small>DACL</SMALL> must be arranged in proper order: <small>ACE</SMALL>s that deny access must come before <small>ACE</SMALL>s that allow access.</P>
<h4 align="LEFT"><a name="Heading7"></A><font color="#000077">Determining the Size Required for an ACL</FONT></H4>
<p>Occasionally, you may need to copy or add an entry to an <small>ACL</SMALL>. Because an <small>ACL</SMALL> is a variable-length structure, you&#146;ll need to determine the size of the <small>ACL</SMALL> and allocate a new buffer that&#146;s large enough to store the (possibly larger) new <small>ACL</SMALL>.</P>
<p>The size of an <small>ACL</SMALL> is determined by adding the size of the <small>ACL</SMALL> structure to the size of all <small>ACL</SMALL>s contained in the list. The simplest way to determine the size is to call the <small>GetAclInformation</SMALL> function, as shown in the following wrapper function:</P>
<!-- CODE //-->
<pre>
BOOL GetAclSize(PACL pacl, LPDWORD pdw)
{
    ACL_SIZE_INFORMATION info;
    BOOL fInfo = GetAclInformation(pacl,
                                   &ampinfo,
                                   sizeof(info),
                                   AclSizeInformation);
    if(fInfo)
        *pdw = info.AclBytesInUse;
    return fInfo;
}
</PRE>
<!-- END CODE //-->
<p>The <small>GetAclInformation</SMALL> function has four parameters:</P>
<dl>
<dd><b>&#149;</B>&nbsp;&nbsp;A pointer to an <small>ACL</SMALL>
<dd><b>&#149;</B>&nbsp;&nbsp;The address of either an <small>ACL_SIZE_INFORMATION</SMALL> structure, if you&#146;re retrieving the size of an <small>ACL</SMALL>, or an <small>ACL_REVISION_INFORMATION</SMALL> structure, to retrieve revision information about the <small>ACL</SMALL>
<dd><b>&#149;</B>&nbsp;&nbsp;The size of the structure in the previous parameter
<dd><b>&#149;</B>&nbsp;&nbsp;Either <small>AclSizeInformation</SMALL>, to retrieve size information from the ACL, or <small>AclRevisionInformation</SMALL>, to retrieve revision information
</DL>
<h4 align="LEFT"><a name="Heading8"></A><font color="#000077">Adding an Access-allowed ACE to a DACL</FONT></H4>
<p>An access-allowed <small>ACE</SMALL> is added to a <small>DACL</SMALL> using the <small>AddAccessAllowedAceEx</SMALL> function:</P>
<!-- CODE //-->
<pre>
BOOL AllowUserAccessThroughAcl(PACL pacl, LPCTSTR lpszUser)
{
    PSID pSid = AccountNameToSid(lpszUser);
    if(!pSid) return FALSE;

    BOOL fAdded = AddAccessAllowedAceEx(pAcl,
                                        ACL_REVISION,
                                        0,
                                        GENERIC_ALL,
                                        pSid);
    LocalFree(pSid);
    return fAdded;
}
</PRE>
<!-- END CODE //-->
<p>As shown in this code fragment, you don&#146;t need to create the <small>ACCESS_ALLOWED_ACE</SMALL> yourself; you simply pass a <small>SID</SMALL> to the <small>AddAccessAllowedAceEx</SMALL> function. <small>AddAccessAllowedAceEx</SMALL> has five parameters:</P>
<dl>
<dd><b>&#149;</B>&nbsp;&nbsp;A pointer to the <small>ACL</SMALL>.
<dd><b>&#149;</B>&nbsp;&nbsp;The revision level of the <small>ACL</SMALL>. This parameter is <small>ACL_REVISION_DS</SMALL> when working with <small>ACL</SMALL>s in Active Directory. Otherwise, this parameter is <small>ACL_REVISION</SMALL>.
<dd><b>&#149;</B>&nbsp;&nbsp;Zero or more flags that specify the inheritance characteristics of the new <small>ACE</SMALL>. Possible values for this parameter are discussed later.
<dd><b>&#149;</B>&nbsp;&nbsp;One or more flags that specify the access rights affected by this <small>ACL</SMALL>. Possible values for this parameter are discussed later.
<dd><b>&#149;</B>&nbsp;&nbsp;A pointer to the <small>SID</SMALL> that will be added to the <small>ACL</SMALL> as an access-allowed <small>ACE</SMALL>.
</DL>
<p>For <small>DACL</SMALL>s that are applied to containers (such as Registry keys, directories, and printers), child objects may inherit <small>ACE</SMALL>s. The following inheritance flags control the type of inheritance allowed:</P>
<dl>
<dd><b>&#149;</B>&nbsp;&nbsp;<small>CONTAINER_INHERIT_ACE</SMALL>. Enables the <small>ACE</SMALL> to be inherited by child objects that are container objects, such as directories, printers, and Registry keys.
<dd><b>&#149;</B>&nbsp;&nbsp;<small>INHERIT_ONLY_ACE</SMALL>. Specifies that the <small>ACE</SMALL> does not apply to this object. However, child objects can inherit it.
<dd><b>&#149;</B>&nbsp;&nbsp;<small>INHERITED_ACE</SMALL>. Specifies an inherited <small>ACE</SMALL> for use in operations on child objects.
<dd><b>&#149;</B>&nbsp;&nbsp;<small>NO_PROPAGATE_INHERIT_ACE</SMALL>. Inhibits the <small>OBJECT_INHERIT_ACE</SMALL> and <small>CONTAINER_INHERIT_ACE</SMALL> flags from being copied to an inherited <small>ACE</SMALL>.
<dd><b>&#149;</B>&nbsp;&nbsp;<small>OBJECT_INHERIT_ACE</SMALL>. Enables the <small>ACE</SMALL> to be inherited by noncontainer child objects, such as files, Registry values, and printer shares.
</DL>
<p><br></P>
<center>
<table border>
<tr>
<td><a href="07-03.html">Previous</A></TD>
<td><a href="../ewtoc.html">Table of Contents</A></TD>
<td><a href="07-05.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>


</font></BODY></HTML>