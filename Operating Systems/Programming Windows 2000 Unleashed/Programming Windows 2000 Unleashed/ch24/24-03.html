<html>
<head>
<meta name=vsisbn content="067231486x">
<meta name=vstitle content="Programming Microsoft Windows 2000 Unleashed">
<meta name=vsauthor content="MICKEY WILLIAMS">
<meta name=vsimprint content="Sams">
<meta name=vspublisher content="Macmillan Computer Publishing">
<meta name=vspubdate content="06/21/99">
<meta name=vscategory content="Operations Systems: Windows 2000">



<title>Programming Microsoft Windows 2000 Unleashed:Using the COM[TITLE]#43; In-Memory Database</TITLE>
<!-- BEGIN HEADER -->
<meta name="ROBOTS" content="NOINDEX, NOFOLLOW">
<script>
<!--
function displayWindow(url, width, height) {
        var Win = window.open(url,"displayWindow",'width=' + width +
',height=' + height + ',resizable=1,scrollbars=yes');
}
//--></SCRIPT>

<!-- HEADER -->
<style type="text/css">
<!--
A:hover { color:red }
-->
</STYLE>

<!-- HEADER -->
<style type="text/css"> 
 <!--
 A:hover  {
 	color : Red;
 }
 -->
 </STYLE>

</HEAD>
<BODY bgcolor=#FFFFFF><FONT size=2 face="Arial, verdana, helvetica"><table width=100% border=0 cellspacing=0 cellpadding=2><tr bgcolor=#000000><td width=100% align=right><b><font color=#FFFFFF>Gotcha</font></b></td></tr></table><br><!--Begin Content Column -->

<table border=0 cellspacing=0 cellpadding=0>
<tr>
<td width=75 valign=top>
<img webstripperattrwas="src" webstripperlinkwas="http://corpitk.earthweb.com/images/sm_covers/067231486x.gif" width=60 height=73 alt="Programming Microsoft Windows 2000 Unleashed" border="1">
</td>
<td align="left">
    <font face="arial, helvetica" size="-1" color="#336633"><b>Programming Microsoft Windows 2000 Unleashed</b></font>
    <br>
    <font face="arial, helvetica" size="-1"><i>by MICKEY WILLIAMS</i>
    <br>
    Sams,&nbsp;Macmillan Computer Publishing
    <br>
    <b>ISBN:</b>&nbsp;067231486x<b>&nbsp;&nbsp;&nbsp;Pub Date:</b>&nbsp;06/21/99</font>
</td>
</tr>
</table>
<p>
<!-- Empty Reference Subhead-->

<!--ISBN=067231486x//-->
<!--TITLE=Programming Microsoft Windows 2000 Unleashed//-->
<!--AUTHOR=Mickey Williams//-->
<!--PUBLISHER=Macmillan Computer Publishing//-->
<!--IMPRINT=sams//-->
<!--CHAPTER=24//-->
<!--PAGES=830-833//-->
<!--UNASSIGNED1//-->
<!--UNASSIGNED2//-->

<center>
<table border>
<tr>
<td><a href="24-02.html">Previous</A></TD>
<td><a href="../ewtoc.html">Table of Contents</A></TD>
<td><a href="24-04.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>
<p><br></P>
<h4 align="LEFT"><a name="Heading9"></A><font color="#000077">What&#146;s Supported at the OLE DB Level</FONT></H4>
<p>There aren&#146;t many situations where you would use OLE DB directly. The only exception involves the Visual Studio 6.0 OLE DB consumer templates. The following interfaces are supported:
</P>
<table width="100%"><th width="40%" valign="TOP" align="LEFT"><i>Object</I>
<th valign="TOP" align="LEFT"><i>Interface</I>
<tr>
<td colspan="2"><hr>
<tr>
<td valign="TOP" align="LEFT">DSO
<td valign="TOP" align="LEFT"><small>IDBCreateSession</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IDBInitialize</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IDBProperties</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IPersist</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>ITableDefinition</SMALL>
<tr>
<td valign="TOP" align="LEFT">Error
<td valign="TOP" align="LEFT"><small>IErrorInfo</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IErrorRecords</SMALL>
<tr>
<td valign="TOP" align="LEFT">Rowset
<td valign="TOP" align="LEFT"><small>IAccessor</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IChapteredRowset</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IColumnsInfo</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IConvertType</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IRowset</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IRowsetChange</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IRowsetIdentity</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IRowsetIndex</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IRowsetInfo</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IRowsetLocate</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IRowsetUpdate</SMALL>
<tr>
<td valign="TOP" align="LEFT">Session
<td valign="TOP" align="LEFT"><small>IGetDataSource</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IOpenRowset</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>ISessionProperties</SMALL>
<tr>
<td valign="TOP" align="LEFT">View
<td valign="TOP" align="LEFT"><small>IAccessor</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IViewChapter</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IViewFilter</SMALL>
<tr>
<td valign="TOP" align="LEFT">
<td valign="TOP" align="LEFT"><small>IViewSort</SMALL>
</TABLE>
<h4 align="LEFT"><a name="Heading10"></A><font color="#000077">How the Specifics Relate to the OLE DB Consumer Templates</FONT></H4>
<p>The IMDB OLE DB provider is special in nature and does not always work as you might expect.
</P>
<p>For example, it does not support OLE DB notifications or the <small>ITransaction</SMALL> interface. What this means is that from the <small>CSession</SMALL> class, the methods <small>StartTransaction</SMALL>, <small>Abort</SMALL>, <small>Commit</SMALL>, and <small>GetTransactionInfo</SMALL> cannot be used. It does not mean that there&#146;s no transaction facility, but rather that the transaction cannot be controlled. The IMDB requires that the client accessing it is within a COM&#43; application that uses that transaction.</P>
<p>Also, there&#146;s no support for <small>ICommand</SMALL> because IMDB does not have a command processor&#151;it&#146;s an ISAM database. To retrieve the data, you would use the <small>IOpenRowset</SMALL> interface. Through this interface you can browse and filter the cached tables. All tables that will be cached must have indexes associated with them.</P>
<p>With the OLE DB consumer templates, the only possible solution is the static accessor or the manual accessor. Anything else will cause errors.</P>
<p>The easiest method is to use the standard accessor and then let the wizard generate the code. This has the advantage of keeping everything lean and fast, yet simple. Consider the following sample source for OLE DB:</P>
<!-- CODE //-->
<pre>
class CdboauthorsAccessor
{
public:
    TCHAR m_auid[12];
    TCHAR m_aulname[41];
    TCHAR m_aufname[21];
    TCHAR m_phone[13];
    TCHAR m_address[41];
    TCHAR m_city[21];
    TCHAR m_state[3];
    TCHAR m_zip[6];
    VARIANT_BOOL m_contract;
 BEGIN_COLUMN_MAP(CdboauthorsAccessor)
    COLUMN_ENTRY(1, m_auid)
    COLUMN_ENTRY(2, m_aulname)
    COLUMN_ENTRY(3, m_aufname)
    COLUMN_ENTRY(4, m_phone)
    COLUMN_ENTRY(5, m_address)
    COLUMN_ENTRY(6, m_city)
    COLUMN_ENTRY(7, m_state)
    COLUMN_ENTRY(8, m_zip)
    COLUMN_ENTRY_TYPE(9, DBTYPE_BOOL, m_contract)
END_COLUMN_MAP()
    // You may wish to call this function if you are inserting a record
    &#8658; and wish to initialize all the fields, if you are not going to
    &#8658; explicitly set all of them.
    void ClearRecord()
    {
        memset(this, 0, sizeof(*this));
    }
};
 class Cdboauthors : public CTable&lt;CAccessor&lt;CdboauthorsAccessor&gt; &gt;
{
public:
    HRESULT Open()
    {
        HRESULT        hr;
         hr = OpenDataSource();
        if (FAILED(hr))
            return hr;
         return OpenRowset();
    }
    HRESULT OpenDataSource()
    {
        HRESULT        hr;
        CDataSource db;
        CDBPropSet    dbinit(DBPROPSET_DBINIT);
        //dbinit.AddProperty(DBPROP_AUTH_PERSIST_SENSITIVE_AUTHINFO,
        &#8658;false);
        //dbinit.AddProperty(DBPROP_AUTH_USERID, OLESTR(&#147;sa&#148;));
        dbinit.AddProperty(DBPROP_INIT_DATASOURCE, OLESTR(&#147;Pubs&#148;));
        dbinit.AddProperty(DBPROP_INIT_PROMPT, (short)4);
        //dbinit.AddProperty(DBPROP_INIT_LCID, (long)1033);
        hr = db.Open(_T(&#147;MSDASQL&#148;), &amp;dbinit);
        if (FAILED(hr))
            return hr;
         return m_session.Open(db);
    }
    HRESULT OpenRowset()
    {
        // Set properties for open
        CDBPropSet    propset(DBPROPSET_ROWSET);
        propset.AddProperty(DBPROP_IRowsetChange, true);
        propset.AddProperty(DBPROP_UPDATABILITY, DBPROPVAL_UP_CHANGE |
        &#8658;DBPROPVAL_UP_INSERT | DBPROPVAL_UP_DELETE);
         return CTable&lt;CAccessor&lt;CdboauthorsAccessor&gt; &gt;::Open
         &#8658;(m_session, _T(&#147;dbo.authors&#148;), &amp;propset);
    }
    CSession    m_session;
};
</PRE>
<!-- END CODE //-->
<p>When you&#146;re connecting to an IMDB data source, some changes have to be made. Therefore, lines 54, 55, and optionally line 58 need to be commented out. There&#146;s no need to specify a user name and password because IMDB uses impersonation or explicit user definition for the security.
</P>
<p>The static accessor is okay because, as specified in line 72, <small>CCommand</SMALL> (<small>ICommand</SMALL>) is not used. Instead <small>CTable</SMALL> is used, which binds to the <small>IOpenRowset</SMALL> interface. When <small>IOpenRowset::OpenRowset</SMALL> is called, it does not specify an index, as shown by the following source code:</P>
<!-- CODE SNIP //-->
<pre>
hr = session.m_spOpenRowset-&gt;OpenRowset(NULL, &amp;dbid, NULL, GetIID(),
    (pPropSet) ? 1 : 0, pPropSet, (IUnknown**)GetInterfacePtr());
</PRE>
<!-- END CODE SNIP //-->
<p>This is good because IMDB does not support the explicit definition of the indexes. The index used is read from the in-memory table. IMDB cannot index on autoincrement fields or on timestamp fields.
</P><p><br></P>
<center>
<table border>
<tr>
<td><a href="24-02.html">Previous</A></TD>
<td><a href="../ewtoc.html">Table of Contents</A></TD>
<td><a href="24-04.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>


</font></BODY></HTML>