<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0057)http://www.insecure.org/sploits/squid.access-control.html -->
<HTML><HEAD><TITLE>Squid access control problem</TITLE>
<META http-equiv=Content-Type content="text/html; charset=iso-8859-1">
<META 
content="The squid http proxy allows an administrator to specify banned sites.  Unfortunately, users can get around this by using URL hex escapes or specifying an IP address." 
name=description>
<META 
content=" IP, Squid, Those, URL, Unfortunately, access, address, administrator, allows, an, around, banned, control, employees, escapes, etc, get, hex, http, keep, problem, proxy, relying, restrictions, sites, specify, specifying, squid, students, this, undesireable, users, using" 
name=keywords>
<META content="MSHTML 6.00.2600.0" name=GENERATOR></HEAD>
<BODY text=#ffffff vLink=#7f7f7f link=#0b7cff bgColor=#000000>
<TABLE cellSpacing=0 cellPadding=0 width="100%">
  <TBODY>
  <TR>
    <TD align=left><A href="http://www.insecure.org/"><IMG height=90 
      src="Squid access control problem_files/Insecurelogo-eye-90x168.gif" 
      width=168 border=0></A> </TD>
    <TD vAlign=bottom align=right><!-- Begin Banner Code --><IFRAME 
      marginWidth=0 marginHeight=0 
      src="Squid access control problem_files/pro.pl" frameBorder=0 width=728 
      scrolling=no 
      height=90>
<SCRIPT LANGUAGE="JavaScript"><!--
random = parseInt(Math.random()*10000)
banner = '<A HREF="http://cgi.insecure.org/cgi-bin/pro/pro.pl?banner=NonSSI;'
banner += 'page=' + random + '" >';
banner += '<IMG SRC="http://cgi.insecure.org/cgi-bin/pro/pro.pl?'
banner += 'page=' + random + '" '
banner += ' ALT="Click Here!" BORDER=0></A>'
document.write(banner)
// --></SCRIPT>
<NOSCRIPT>
<A HREF="http://cgi.insecure.org/cgi-bin/pro/pro.pl?banner=NonSSI;page=01">
<IMG SRC="http://cgi.insecure.org/cgi-bin/pro/pro.pl?page=01"
     ALT="Click Here!" BORDER=0></A>
</NOSCRIPT>
</IFRAME><!-- End Banner Code --></TD></TR></TBODY></TABLE>
<CENTER>
<H1><B>Squid access control problem</B></H1></CENTER>
<TABLE width="100%">
  <TBODY>
  <TR bgColor=#005f00>
    <TH align=middle><B>Summary</B></TH></TR></TBODY></TABLE>
<TABLE>
  <TBODY>
  <TR>
    <TD vAlign=top><B>Description:</B></TD>
    <TD>The squid http proxy allows an administrator to specify banned sites. 
      Unfortunately, users can get around this by using URL hex escapes or 
      specifying an IP address.</TD></TR>
  <TR>
    <TD vAlign=top><B>Author:</B></TD>
    <TD>"Vitaly V. Fedrushkov" &lt;willy@CSU.AC.RU&gt; and Mauro Lacy 
      &lt;mauro@INTER-SOFT.COM&gt;</TD></TR>
  <TR>
    <TD vAlign=top><B>Compromise:</B></TD>
    <TD>Bypass some squid access restrictions.</TD></TR>
  <TR>
    <TD vAlign=top><B>Vulnerable Systems:</B></TD>
    <TD>Those relying on squid access restrictions to keep students, 
      employees, etc. from undesireable sites.</TD></TR>
  <TR>
    <TD vAlign=top><B>Date:</B></TD>
    <TD>23 February 1998</TD></TR><!-- <TR><TD VALIGN="top"><B>Notes:</B></TD><TD> </TD></TR> --></TBODY></TABLE>
<TABLE width="100%">
  <TBODY>
  <TR bgColor=#005f00>
    <TH align=middle><B>Details</B></TH></TR></TBODY></TABLE><BR><PRE><B>Date:</B>         Fri, 20 Feb 1998 08:04:00 +0500
<B>From:</B>         "Vitaly V. Fedrushkov" &lt;willy@CSU.AC.RU&gt;
<B>Subject:</B>      Simple way to bypass squid ACLs

-----BEGIN PGP SIGNED MESSAGE-----

Good $daytime,

Software:       Squid Internet Object Cache
Version:        1.1.20 (at least)
Summary:        any URL-based ACLs can be bypassed using
                simple rewriting
Impact:         renders any access control based on url_regex
                and/or urlpath_regex unusable


Details
~~~~~~~
It is possible to bypass squid access control rules based on URL
regular expressions.  Due to insufficient URL parsing it is possible
to rewrite URL with hex escapes so that it is no longer matched
against some rule but remains valid for replying server.


Example
~~~~~~~
squid.conf:
        ...
        acl PornoURLs url_regex "/var/lib/squid/etc/PornoURLs.acl"
        ...
        http_access     deny    PornoURLs
        ...

PornoURLs.acl:
        ...
        aha.ru.*/~sands/
        ...

netscape <A href="http://www.aha.ru/~sands/">http://www.aha.ru/~sands/</A>      -&gt; Access denied
netscape <A href="http://www.aha.ru/~sands/">http://www.aha.ru/~sands/</A>
  -&gt; 200 OK

_BUT_

<A href="http://www.ravage.com/plypage/html/nude.html">http://www.ravage.com/plypage/html/nude.html</A>     -&gt; Access denied
<A href="http://www.ravage.com/plypage/html/unde.html">http://www.ravage.com/plypage/html/unde.html</A> -&gt; 404 Object Not Found

Impact
~~~~~~
Any access restrictions based on such ACLs can be easily broken by
clients.  In my case it can be used for acceptable usage policy (AUP)
violation.


Workaround
~~~~~~~~~~
1. Rewrite regexps to match any valid URL rewriting.  Seems tricky
and result is unreadable by human (== easy to mistype).

2. Use some request-rewriting software at proxy port to canonify
request and forward it to squid.  This breaks port- and IDENT-based
rules.


Other software
~~~~~ ~~~~~~~~
As you can see, result depends on server implementation.  RFC1738 says
MAY on escaping printable characters.  Also it is stated that such
escapes may change URL semantics.  None the less, any other software
that uses URL matching is about to be checked.

Thanks for your time.

  Regards,
  Willy.

- - --
"No easy hope or lies        | Vitaly "Willy the Pooh" Fedrushkov
 Shall bring us to our goal, | Information Technology Division
 But iron sacrifice          | Chelyabinsk State University
 Of Body, Will and Soul."    | mailto:willy@csu.ac.ru  +7 3512 156770
                   R.Kipling | <A href="http://www.csu.ac.ru/~willy">http://www.csu.ac.ru/~willy</A>  VVF1-RIPE

-----BEGIN PGP SIGNATURE-----
Version: 2.6.3ia
Charset: koi8

iQCVAwUBNOzyUzslK91NCq/tAQHQ5QQAksWEioRWwwowl1TIHaVimE2i5AxEAYw4
3qOSJYI7bY2+0pM1R+1By+A8sWU6cPpvetNopO7DhRD/ytX01UiImoMfvw1vg5ET
VAmIPMI0AI/O5fvkjXoLtJBsDaWc2t51NE4Z9Q6NHn6tnjTIIX1toSNJKxylZL0L
xn7Tr3KnSXI=
=6k0i
-----END PGP SIGNATURE-----


Date: Mon, 23 Feb 1998 13:08:41 -0300
From: Mauro Lacy &lt;mauro@INTER-SOFT.COM&gt;
To: BUGTRAQ@NETSPACE.ORG
Subject: Re: Simple way to bypass squid ACLs

Vitaly V. Fedrushkov wrote:
&gt;
&gt; -----BEGIN PGP SIGNED MESSAGE-----
&gt;
&gt; Good $daytime,
&gt;
&gt; Software:       Squid Internet Object Cache
&gt; Version:        1.1.20 (at least)
&gt; Summary:        any URL-based ACLs can be bypassed using
&gt;                 simple rewriting
&gt; Impact:         renders any access control based on url_regex
&gt;                 and/or urlpath_regex unusable
&gt;
&gt; Details
&gt; ~~~~~~~
&gt; It is possible to bypass squid access control rules based on URL
&gt; regular expressions.  Due to insufficient URL parsing it is possible
&gt; to rewrite URL with hex escapes so that it is no longer matched
&gt; against some rule but remains valid for replying server.

You can also replace the URL by its numerical IP address(at least this
works for the proxy of my company) eg.:

 netscape http://www.playboy.com                -&gt; Access denied
 nslookup www.playboy.com
        ...
        Non-authoritative answer:
        Name:    wdc.express.playboy.com
        Addresses:  206.251.29.12, 205.216.146.201
        Aliases:  www.playboy.com, www.express.playboy.com

 netscape http://206.251.29.12                  -&gt; OK!
 or
 netscape http://205.216.146.201                -&gt; OK!

&gt; ...
&gt; Workaround
&gt; ~~~~~~~~~~
&gt; 1. Rewrite regexps to match any valid URL rewriting.  Seems tricky
&gt; and result is unreadable by human (== easy to mistype).
&gt;
&gt; 2. Use some request-rewriting software at proxy port to canonify
&gt; request and forward it to squid.  This breaks port- and IDENT-based
&gt; rules.
&gt;

I suppose that in this case you have to add the numerical IP of the URL
in the ACL.
eg.:
 PornoURLs.acl:
         ...
         www.playboy.com
         206.251.29.12
         205.216.146.201
         ...

Everybody: please don't tell my company sysadmin. :-))

&gt; - - --
&gt; "No easy hope or lies        | Vitaly "Willy the Pooh" Fedrushkov
&gt;  Shall bring us to our goal, | Information Technology Division
&gt;  But iron sacrifice          | Chelyabinsk State University
&gt;  Of Body, Will and Soul."    | mailto:willy@csu.ac.ru  +7 3512 156770
&gt;                    R.Kipling | http://www.csu.ac.ru/~willy  VVF1-RIPE

I agree.

Mauro
--
Mauro Lacy                   -              mauro@inter-soft.com
Intersoft Argentina          -              http://www.inter-soft.com
</PRE><PRE>
</PRE>
<TABLE width="100%">
  <TBODY>
  <TR bgColor=#005f00>
    <TH align=middle><B>More Exploits!</B></TH></TR></TBODY></TABLE><BR>The master 
index of all exploits is available <A 
href="http://www.insecure.org/sploits_all.html">here</A> (Very large file)<BR>Or 
you can pick your favorite operating system:<BR>
<TABLE border=1>
  <TBODY>
  <TR>
    <TD><A href="http://www.insecure.org/sploits_all.html">All OS's</A></TD>
    <TD><A href="http://www.insecure.org/sploits_linux.html">Linux</A></TD>
    <TD><A 
      href="http://www.insecure.org/sploits_solaris.html">Solaris/SunOS</A></TD>
    <TD><A 
    href="http://www.insecure.org/sploits_microshit.html">Micro$oft</A></TD></TR>
  <TR>
    <TD><A href="http://www.insecure.org/sploits_bsd.html">*BSD</A></TD>
    <TD><A href="http://www.insecure.org/sploits_mac.html">Macintosh</A></TD>
    <TD><A href="http://www.insecure.org/sploits_aix.html">AIX</A></TD>
    <TD><A href="http://www.insecure.org/sploits_irix.html">IRIX</A></TD></TR>
  <TR>
    <TD><A href="http://www.insecure.org/sploits_ultrix.html">ULTRIX/Digital 
      UNIX</A></TD>
    <TD><A href="http://www.insecure.org/sploits_hpux.html">HP/UX</A></TD>
    <TD><A href="http://www.insecure.org/sploits_sco.html">SCO</A></TD>
    <TD><A href="http://www.insecure.org/sploits_remote.html">Remote 
      exploits</A></TD></TR></TBODY></TABLE><BR>This page is part of <A 
href="http://www.insecure.org/sploits.html">Fyodor's exploit world</A>. For a 
free program to automate scanning your network for vulnerable hosts and 
services, check out my network mapping tool, <A 
href="http://www.insecure.org/nmap/index.html">nmap</A>. Or try these <A 
href="http://www.insecure.org/">Insecure.Org</A> resouces:<BR><BR>
<CENTER>[ <A href="http://www.insecure.org/nmap/index.html"><FONT 
color=#ffffff>Nmap</FONT></A> | <A 
href="http://www.insecure.org/tools.html"><FONT color=#ffffff>Tools</FONT></A> | 
<A href="http://lists.insecure.org/"><FONT color=#ffffff>Lists</FONT></A> | <A 
href="http://www.insecure.org/reading.html"><FONT 
color=#ffffff>Reading</FONT></A> | <A href="http://www.insecure.org/"><FONT 
color=#ffffff>News</FONT></A> | <A 
href="http://www.insecure.org/myworld.html"><FONT 
color=#ffffff>About/Contact</FONT></A> | <A 
href="http://www.insecure.org/advertising.html"><FONT 
color=#ffffff>Advertising</FONT></A> | <A 
href="http://www.insecure.org/privacy.html"><FONT color=#ffffff>Privacy 
Policy</FONT></A> ]<BR></CENTER></BODY></HTML>
